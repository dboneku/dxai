<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCR.AI ROI Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', Arial, sans-serif;
            background: linear-gradient(135deg, #4a5a7a 0%, #5a6a8a 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #3a4a5a 0%, #4a5a6a 100%);
            padding: 40px;
            text-align: center;
            color: white;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .input-section,
        .results-section {
            background: #e1e5ea;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border-left: 5px solid #3a5a5a;
        }

        .input-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px 20px;
        }

        .input-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .input-group label {
            flex: 1;
            margin-right: 10px;
            font-weight: 600;
            color: #555;
            text-align: right;
        }

        .input-group input {
            flex: 1;
            padding: 8px;
            border: 2px solid #e1e5ea;
            border-radius: 8px;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #4facfe;
        }

        /* .results-section {
            background: linear-gradient(135deg, #4a5a7a 0%, #5a6a8a 100%);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
        } */

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .results-table th,
        .results-table td {
            padding: 10px;
            border: 1px solid #667eea;
            text-align: left;
        }

        .results-table th {
            background-color: #3a4a5a;
            color: white;
        }

        .result-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .result-card h3 {
            font-size: 1.1em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .result-card .value {
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .result-card .unit {
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* Value cards (presentation style) */
        .value-cards {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .value-card {
            flex: 1 1 0;
            background: #ffffff; /* white background */
            color: #0b6b66; /* dark teal text */
            border-radius: 12px;
            padding: 22px 18px;
            text-align: center;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
            border: 4px solid #0b6b66; /* thick dark teal border */
            min-width: 0; /* allow flex children to shrink without overflow */
        }

        .value-card h3 {
            margin: 0 0 12px 0;
            color: #0b6b66;
            font-weight: 800;
            font-size: 1.02em;
        }

        .value-card .card-value {
            font-size: 1.8em;
            font-weight: 800;
        }

        @media (max-width: 800px) {
            .value-cards {
                flex-direction: column;
            }
        }

        .clinical-evidence {
            background: #d1e4e8;
            border-radius: 12px;
            padding: 25px;
            margin: 30px 0;
            border-left: 5px solid #3a5a5a;
        }

        .clinical-evidence h3 {
            color: #17a2b8;
            margin-bottom: 15px;
        }

        .evidence-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .evidence-stat {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .evidence-stat .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #17a2b8;
        }

        .evidence-stat .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .benefits-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .benefit-card {
            background: #f1f5f8;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-top: 4px solid #3a5a5a;
        }

        .benefit-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .benefit-list {
            list-style: none;
        }

        .benefit-list li {
            padding: 8px 0;
            color: #666;
            position: relative;
            padding-left: 25px;
        }

        .benefit-list li::before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: #4facfe;
            font-weight: bold;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            min-width: 160px;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3a4a5a 0%, #4a5a6a 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4a5a7a 0%, #5a6a8a 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .content {
                padding: 20px;
            }

            .input-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header" style="position: relative;">
            <h1>PCR.AI ROI Business Case</h1>
            <p>Calculate the financial impact and return on investment for your laboratory</p>
        </div>

        <div class="content">
            <div class="input-section" style="position: relative;">
                <button class="btn btn-secondary" style="position: absolute; top: 10px; right: 10px;" onclick="resetForm()">Reset
                </button>
                <h2>Laboratory Parameters</h2>
                <div class="input-grid">
                    <div class="input-group" style="grid-column: span 2;">
                        <label
                            style="font-weight: bold; text-align: center; background-color: #4a5a6a; color: white;">Calculation
                            Mode</label>
                    </div>
                    <div class="input-group" style="grid-column: span 2; display: flex; justify-content: space-around;">
                        <label>
                            <input type="radio" name="calculationMode" value="runs" checked>
                            Runs per Day/Week/Month/Year
                        </label>
                        <label>
                            <input type="radio" name="calculationMode" value="annual">
                            Annual Sample Volume
                        </label>
                    </div>
                    <hr style="grid-column: span 2; border: 0; border-top: 2px solid #ccc; margin: 20px 0;">
                    <div id="runFrequencyInputs">
                        <div class="input-group">
                            <label for="runsPerFrequency">Runs per Frequency</label>
                            <input type="number" id="runsPerFrequency" value="5" min="1">
                        </div>
                        <div class="input-group">
                            <label for="frequency">Frequency</label>
                            <select id="frequency">
                                <option value="day" selected>Per Day</option>
                                <option value="week">Per Week</option>
                                <option value="month">Per Month</option>
                                <option value="year">Per Year</option>
                            </select>
                        </div>
                    </div>
                    <div id="annualVolumeInputs" style="display: none;">
                        <div class="input-group">
                            <label for="annualSamples">Annual Sample Volume</label>
                            <input type="number" id="annualSamples" value="50000" min="1000">
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="techHourlyRate">Technologist Hourly Rate ($)</label>
                        <input type="number" id="techHourlyRate" value="35" min="15" step="0.50">
                    </div>
                    <div class="input-group">
                        <label for="supervisorRate">Supervisor Hourly Rate ($)</label>
                        <input type="number" id="supervisorRate" value="45" min="20" step="0.50">
                    </div>
                    <div class="input-group">
                        <label for="currentAnalysisTime">Current Analysis Time (minutes/run)</label>
                        <input type="number" id="currentAnalysisTime" value="60" min="10">
                    </div>
                    <div class="input-group" style="grid-column: span 2; margin-top: 20px;">
                        <label
                            style="font-weight: bold; text-align: center; background-color: #4a5a6a; color: white;">Savings
                            Parameters</label>
                    </div>
                    <div class="input-group">
                        <label for="errorRateReduction">Error Rate Reduction (%)</label>
                        <input type="number" id="errorRateReduction" value="3" min="0" max="100" step="0.1">
                    </div>
                    <div class="input-group">
                        <label for="qcTimeSavings">QC/Analysis/Reporting Time Savings (% of analysis time)</label>
                        <input type="number" id="qcTimeSavings" value="90" min="0" max="100" step="0.1">
                    </div>
                    <div class="input-group" style="grid-column: span 2; margin-top: 20px;">
                        <label
                            style="font-weight: bold; text-align: center; background-color: #4a5a6a; color: white;">PCR.AI
                            License Cost</label>
                    </div>
                    <div class="input-group">
                        <label for="samplesPerRun">Samples per Run</label>
                        <input type="number" id="samplesPerRun" value="90" min="1">
                    </div>
                    <div class="input-group">
                        <label for="pcraiCost">Annual PCR.AI License Cost ($)</label>
                        <input type="text" id="pcraiCost" name="pcraiCost">
                    </div>
                    <p style="font-size: 0.9em; color: #666; margin-top: 5px;">We offer discounts for commitments.</p>
                </div>
            </div>

            <div class="results-section">
                <h2>Financial Impact Analysis</h2>

                <h3 style="margin-top: 40px">Savings</h3>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Savings (Annual)</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Total Time Saved</td>
                            <td id="totalTimeSaved">0 hours per year (including QC/Analysis/Reporting)</td>
                        </tr>
                        <tr>
                            <td>Labor Cost Savings</td>
                            <td id="annualSavings">$0</td>
                        </tr>
                        <tr>
                            <td>Error Cost Savings</td>
                            <td id="errorCostSavings">$0</td>
                        </tr>
                        <tr>
                            <td>Savings per Sample</td>
                            <td id="perSampleSavings">$0.00 per sample</td>
                        </tr>
                        <tr>
                            <td>Total Annual Savings</td>
                            <td id="totalAnnualSavings">$0</td>
                        </tr>
                    </tbody>
                </table>

                <h3 style="margin-top: 40px">Value</h3>
                <div class="value-cards" role="region" aria-label="Key value metrics">
                    <div class="value-card" id="card-roi">
                        <h3>Return on Investment</h3>
                        <div class="card-value" id="roi">0% first year ROI</div>
                    </div>
                    <div class="value-card" id="card-payback">
                        <h3>Payback Period</h3>
                        <div class="card-value" id="payback">0 months</div>
                    </div>
                    <div class="value-card" id="card-netbenefit">
                        <h3>Net Benefit</h3>
                        <div class="card-value" id="netBenefit">$0 first year</div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="downloadPDF()">
                        Download PDF Report
                    </button>
                    <!-- <button class="btn btn-secondary" onclick="emailReport()">
                        Email Report
                    </button> -->
                </div>
                <div style="margin: 20px;">
                    <p><strong>Assumptions:</strong></p>
                    <ul style="margin: 20px;">
                        <li>Samples per run used = 90</li>
                        <li>Cost per error used = $50/error</li>
                        <li>Assumes a 5-day work week and a single shift when calculating runs per year</li>
                        <li>Assumes a $50 cost per error</li>
                        <li>Assumes a 70%:30% split between technologist and supervisor costs</li>
                    </ul>
                    
                    <p><strong>Formulas:</strong></p>
                    <ul style="margin: 20px;">
                        <li>Annual Labor Cost Savings = Total Hours Saved Ã— Average Hourly Rate</li>
                        <li>Average Hourly Rate = (Technologist Rate Ã— 70%) + (Supervisor Rate Ã— 30%)</li>
                        <li>Error Cost Savings = Errors Prevented Ã— Cost per Error</li>
                        <li>Errors Prevented = Annual Samples Ã— (Error Rate Reduction / 100)</li>
                        <li>Return on Investment (ROI) = (Net Benefit / PCR.AI License Cost) Ã— 100</li>
                        <li>Net Benefit = Annual Labor Savings - PCR.AI License Cost</li>
                        <li>Payback Period = (PCR.AI License Cost / Annual Labor Savings) Ã— 12</li>
                        <li>Total Hours Saved = (Time Savings per Run Ã— Runs per Year) + QC Time Savings</li>
                    </ul>
                </div>
            </div>

            <div class="clinical-evidence">
                <h3>Clinical Evidence & Performance</h3>
                <p>PCR.AI has been validated in multiple peer-reviewed studies with proven clinical outcomes:</p>
                <div class="evidence-stats">
                    <div class="evidence-stat">
                        <div class="stat-value">100%</div>
                        <div class="stat-label">Concordance Rate<br>(22,200 interpretations)</div>
                    </div>
                    <div class="evidence-stat">
                        <div class="stat-value">35+ min</div>
                        <div class="stat-label">Average Time Savings<br>per Run</div>
                    </div>
                    <div class="evidence-stat">
                        <div class="stat-value">90%</div>
                        <div class="stat-label">Reduction in<br>Analysis Time</div>
                    </div>
                    <div class="evidence-stat">
                        <div class="stat-value">1M+</div>
                        <div class="stat-label">Results<br>Reported</div>
                    </div>
                </div>
            </div>

            <div class="benefits-section">
                <div class="benefit-card">
                    <h3>Operational Benefits</h3>
                    <ul class="benefit-list">
                        <li>90% reduction in manual analysis time</li>
                        <li>24/7 automated processing capability</li>
                        <li>Standardized interpretation across all staff</li>
                        <li>Reduced dependency on senior technologists</li>
                        <li>Faster turnaround times for critical results</li>
                        <li>Enhanced throughput capacity</li>
                    </ul>
                </div>

                <div class="benefit-card">
                    <h3>Quality & Compliance</h3>
                    <ul class="benefit-list">
                        <li>100% concordance with manual analysis</li>
                        <li>Elimination of transcription errors</li>
                        <li>Complete audit trail and documentation</li>
                        <li>Real-time QC monitoring and alerts</li>
                        <li>ISO 27001 and HIPAA compliant</li>
                        <li>21 CFR Part 11 validation ready</li>
                    </ul>
                </div>

                <div class="benefit-card">
                    <h3>Strategic Advantages</h3>
                    <ul class="benefit-list">
                        <li>Scalable for laboratory growth</li>
                        <li>Compatible with all major thermocyclers</li>
                        <li>Seamless LIMS integration</li>
                        <li>Staff redeployment to higher-value activities</li>
                        <li>Improved staff satisfaction and retention</li>
                        <li>Enhanced competitive positioning</li>
                    </ul>
                </div>
            </div>

        </div>

        <div class="footer">
            <p>Based on clinical validation studies published in Journal of Clinical Virology and Journal of Virological
                Methods<br>
                Contact your PCR.AI representative for a customized demonstration</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script>
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        document.querySelectorAll('input[name="calculationMode"]').forEach(function (radio) {
            radio.addEventListener('change', function () {
                var mode = document.querySelector('input[name="calculationMode"]:checked').value;
                var annualInputs = document.getElementById('annualVolumeInputs');
                var runInputs = document.getElementById('runFrequencyInputs');

                if (mode === 'annual') {
                    annualInputs.style.display = 'block';
                    runInputs.style.display = 'none';
                } else {
                    annualInputs.style.display = 'none';
                    runInputs.style.display = 'block';
                }

                calculateROI();
            });
        });

        function calculateLicenseFee(annualSamples) {
            if (annualSamples <= 12000) {
                return 30000 + (annualSamples * 0.35);
            } else if (annualSamples <= 200000) {
                return 45000 + (annualSamples * 0.25);
            } else {
                // Cap at 120k for up to 350k samples
                return Math.min(120000, 45000 + (200000 * 0.25) + ((annualSamples - 200000) * 0.25));
            }
        }

        function calculateROI() {
            var calculationMode = document.querySelector('input[name="calculationMode"]:checked').value;
            var annualSamples = 0;
            var runsPerYear = 0;
            // Read samplesPerRun from the UI so it's adjustable
            var samplesPerRun = parseInt(document.getElementById('samplesPerRun') && document.getElementById('samplesPerRun').value) || 40;

            if (calculationMode === 'annual') {
                // User provided annual sample volume directly
                annualSamples = parseInt(document.getElementById('annualSamples').value) || 0;
                // Derive runsPerYear from samples if needed for run-based savings
                runsPerYear = Math.ceil(annualSamples / samplesPerRun);
            } else {
                var runsPerFrequency = parseInt(document.getElementById('runsPerFrequency').value) || 0;
                var frequency = document.getElementById('frequency').value;

                switch (frequency) {
                    case 'day':
                        runsPerYear = runsPerFrequency * 5 * 52; // 5-day work week, 52 weeks per year
                        break;
                    case 'week':
                        runsPerYear = runsPerFrequency * 52;
                        break;
                    case 'month':
                        runsPerYear = runsPerFrequency * 12;
                        break;
                    case 'year':
                        runsPerYear = runsPerFrequency;
                        break;
                }

                // Convert runs per year to samples per year
                annualSamples = runsPerYear * samplesPerRun;
            }

            var techRate = parseFloat(document.getElementById('techHourlyRate').value) || 0;
            var supervisorRate = parseFloat(document.getElementById('supervisorRate').value) || 0;
            var currentAnalysisTime = parseInt(document.getElementById('currentAnalysisTime').value) || 0;
            var pcraiCostInput = parseFloat(document.getElementById('pcraiCost').value) || 0;
            var pcraiCost = calculateLicenseFee(annualSamples);
            // Allow manual override if user edits the cost field
            if (pcraiCostInput && pcraiCostInput !== 0) {
                pcraiCost = pcraiCostInput;
            }
            document.getElementById('pcraiCost').value = Math.round(pcraiCost);
            var errorRateReduction = parseFloat(document.getElementById('errorRateReduction').value) || 0;
            // QC time savings is a percentage of the current analysis time (e.g. 90)
            var qcTimeSavingsPercent = parseFloat(document.getElementById('qcTimeSavings').value) || 0;

            // Assumptions for error cost (define here to avoid ReferenceError)
            var costPerError = 50; // Default cost per error, can be adjusted
            var baselineErrorRate = 0.05; // 5% baseline error rate (can be adjusted)

            var timeSavingsPerRun = currentAnalysisTime * 0.9; // Use 90% of current analysis time for savings
            var totalMinutesSaved = runsPerYear * timeSavingsPerRun; // minutes saved across all runs
            // convert QC savings percent into minutes saved per run
            var qcMinutesSavedPerRun = currentAnalysisTime * (qcTimeSavingsPercent / 100);
            var qcMinutesSaved = runsPerYear * qcMinutesSavedPerRun;
            var totalMinutesSavedAll = totalMinutesSaved + qcMinutesSaved;
            var totalHoursSaved = totalMinutesSavedAll / 60;
            var avgHourlyRate = (techRate * 0.7) + (supervisorRate * 0.3);
            var annualLaborSavings = totalHoursSaved * avgHourlyRate;

            // Error cost savings calculation (now using samples)
            var errorsPerYear = annualSamples * baselineErrorRate;
            var errorsPrevented = annualSamples * (errorRateReduction / 100);
            var errorCostSavings = errorsPrevented * costPerError;

            var netBenefit = annualLaborSavings + errorCostSavings - pcraiCost;
            var roi = pcraiCost > 0 ? (netBenefit / pcraiCost) * 100 : 0;
            var paybackMonths = annualLaborSavings > 0 ? (pcraiCost / annualLaborSavings) * 12 : 0;
            // Allocate PCR.AI license cost across samples so per-sample reflects net impact
            var netAnnualSavings = annualLaborSavings + errorCostSavings - pcraiCost;
            var perSampleSavings = annualSamples > 0 ? netAnnualSavings / annualSamples : 0;
            var totalAnnualSavings = annualLaborSavings + errorCostSavings;

             document.getElementById('totalTimeSaved').textContent = formatNumber(Math.round(totalHoursSaved)) + ' hours per year (including QC/Analysis/Reporting)';
             document.getElementById('annualSavings').textContent = '$' + formatNumber(Math.round(annualLaborSavings));
             document.getElementById('errorCostSavings').textContent = '$' + formatNumber(Math.round(errorCostSavings));
             document.getElementById('totalAnnualSavings').textContent = '$' + formatNumber(Math.round(totalAnnualSavings));
             document.getElementById('perSampleSavings').textContent = '$' + perSampleSavings.toFixed(2) + ' per sample (net of license)';
            document.getElementById('roi').textContent = Math.round(roi) + '% first year ROI';
            document.getElementById('payback').textContent = paybackMonths.toFixed(1) + ' months';
            document.getElementById('netBenefit').textContent = '$' + formatNumber(Math.round(netBenefit)) + ' first year';

            console.debug('calculateROI:', {
                calculationMode: calculationMode,
                runsPerYear: runsPerYear,
                samplesPerRun: samplesPerRun,
                annualSamples: annualSamples,
                timeSavingsPerRun: timeSavingsPerRun,
                qcTimeSavingsPercent: qcTimeSavingsPercent,
                qcMinutesSavedPerRun: qcMinutesSavedPerRun,
                totalHoursSaved: totalHoursSaved,
                annualLaborSavings: annualLaborSavings,
                errorCostSavings: errorCostSavings,
                perSampleSavings: perSampleSavings
            });

            // Populate on-page debug panel
            var dbg = '';
            dbg += 'runsPerYear: ' + runsPerYear + '\n';
            dbg += 'samplesPerRun: ' + samplesPerRun + '\n';
            dbg += 'annualSamples: ' + annualSamples + '\n\n';
            dbg += 'timeSavingsPerRun (min): ' + timeSavingsPerRun + '\n';
            dbg += 'qcTimeSavingsPercent (% of analysis time): ' + qcTimeSavingsPercent + '%\n';
            dbg += 'qcMinutesSavedPerRun (min): ' + qcMinutesSavedPerRun.toFixed(2) + '\n';
            dbg += 'totalHoursSaved: ' + totalHoursSaved.toFixed(2) + ' hrs\n';
            dbg += 'avgHourlyRate: $' + avgHourlyRate.toFixed(2) + '\n';
            dbg += 'annualLaborSavings: $' + annualLaborSavings.toFixed(2) + '\n';
            dbg += 'errorCostSavings: $' + errorCostSavings.toFixed(2) + '\n';
            dbg += 'pcraiCost: $' + pcraiCost.toFixed(2) + '\n';
            dbg += 'netAnnualSavings: $' + netAnnualSavings.toFixed(2) + '\n\n';
            dbg += 'perSampleSavings = netAnnualSavings / annualSamples = ' + perSampleSavings.toFixed(4) + '\n';
            var debugContentEl = document.getElementById('debugContent');
            if (debugContentEl) debugContentEl.textContent = dbg;
        }

        // Auto-calculate license cost based on current sample volume
        function updateLicenseCost() {
            var annualSamplesEl = document.getElementById('annualSamples');
            var annualSamples = 0;
            var samplesPerRun = parseInt(document.getElementById('samplesPerRun').value) || 40;
            var runsPerYear = 0;
            var mode = document.querySelector('input[name="calculationMode"]:checked').value;

            if (mode === 'annual') {
                annualSamples = parseInt(annualSamplesEl.value) || 0;
            } else {
                var runsPerFrequency = parseInt(document.getElementById('runsPerFrequency').value) || 0;
                var frequency = document.getElementById('frequency').value;
                switch (frequency) {
                    case 'day': runsPerYear = runsPerFrequency * 5 * 52; break;
                    case 'week': runsPerYear = runsPerFrequency * 52; break;
                    case 'month': runsPerYear = runsPerFrequency * 12; break;
                    case 'year': runsPerYear = runsPerFrequency; break;
                }
                annualSamples = runsPerYear * samplesPerRun;
            }
            var autoCost = calculateLicenseFee(annualSamples);
            document.getElementById('pcraiCost').value = Math.round(autoCost);
        }

        function downloadPDF() {
            var { jsPDF } = window.jspdf;

            // Create a new jsPDF instance
            var doc = new jsPDF('p', 'pt', 'a4');

            // Build a clean summary DOM (labels + values) instead of cloning the live form to avoid visual controls
            var report = document.createElement('div');
            report.style.fontFamily = 'Arial, sans-serif';
            report.style.color = '#222';
            report.style.padding = '10px';

            // Make the report a fixed width so html2canvas renders predictably
            report.style.maxWidth = '560px';
            report.style.width = '560px';

            // Title (centered, visible)
            var title = document.createElement('h2');
            title.textContent = 'PCR.AI ROI Report';
            title.style.margin = '6px 0 12px 0';
            title.style.fontSize = '20px';
            title.style.fontWeight = '800';
            title.style.textAlign = 'center';
            title.style.color = '#0b6b66';
            report.appendChild(title);

            // Pull Assumptions & Formulas from the page so the PDF matches the UI content
            var assumptionsHTML = ''; // dynamically populated
            var formulasHTML = ''; // dynamically populated

            try {
                // Extract assumptions and formulas dynamically
                var assumptionStrong = Array.from(document.querySelectorAll('p strong')).find(function (s) {
                    return /assumption/i.test(s.textContent);
                });
                if (assumptionStrong) {
                    var p = assumptionStrong.parentElement;
                    var ul = p.nextElementSibling;
                    if (ul && ul.tagName && ul.tagName.toLowerCase() === 'ul') {
                        assumptionsHTML = ul.outerHTML;
                    }
                }

                var formulaStrong = Array.from(document.querySelectorAll('p strong')).find(function (s) {
                    return /formula/i.test(s.textContent);
                });
                if (formulaStrong) {
                    var p2 = formulaStrong.parentElement;
                    var ul2 = p2.nextElementSibling;
                    if (ul2 && ul2.tagName && ul2.tagName.toLowerCase() === 'ul') {
                        formulasHTML = ul2.outerHTML;
                    }
                }
            } catch (err) {
                console.debug('Error extracting assumptions/formulas for PDF:', err);
            }

            // Inputs summary as a table
            var inputsSummary = document.createElement('table');
            inputsSummary.style.width = '100%';
            inputsSummary.style.borderCollapse = 'separate';
            inputsSummary.style.borderSpacing = '8px 6px';
            inputsSummary.style.marginBottom = '14px';

            function addSummaryRow(labelText, valueText) {
                var tr = document.createElement('tr');
                var tdLabel = document.createElement('td');
                tdLabel.textContent = labelText;
                tdLabel.style.width = '40%';
                tdLabel.style.fontWeight = '700';
                tdLabel.style.color = '#0b6b66';
                tdLabel.style.fontSize = '11px';
                var tdVal = document.createElement('td');
                tdVal.textContent = valueText;
                tdVal.style.width = '60%';
                tdVal.style.fontSize = '12px';
                tdVal.style.color = '#222';
                tr.appendChild(tdLabel);
                tr.appendChild(tdVal);
                inputsSummary.appendChild(tr);
            }

            // Read input values and add to summary
            var runsPerFrequency = document.getElementById('runsPerFrequency').value || '0';
            var frequency = document.getElementById('frequency').value || '';
            var techRate = document.getElementById('techHourlyRate').value || '0';
            var supervisorRate = document.getElementById('supervisorRate').value || '0';
            var currentAnalysisTime = document.getElementById('currentAnalysisTime').value || '0';
            var errorRateReduction = document.getElementById('errorRateReduction').value || '0';
            var qcTimeSavingsPercent = document.getElementById('qcTimeSavings').value || '0';
            var samplesPerRun = document.getElementById('samplesPerRun').value || '0';
            var pcraiCost = document.getElementById('pcraiCost').value || '0';

            addSummaryRow('Runs per Frequency', runsPerFrequency + ' Ã— ' + frequency);
            addSummaryRow('Technologist Rate ($/hr)', '$' + techRate);
            addSummaryRow('Supervisor Rate ($/hr)', '$' + supervisorRate);
            addSummaryRow('Analysis Time (min/run)', currentAnalysisTime + ' min');
            addSummaryRow('Error Rate Reduction (%)', errorRateReduction + '%');
            addSummaryRow('QC Time Savings (%)', qcTimeSavingsPercent + '%');
            addSummaryRow('Samples per Run', samplesPerRun);
            addSummaryRow('PCR.AI License Cost (annual)', '$' + pcraiCost);

            report.appendChild(inputsSummary);

            // Savings table
            var savingsTable = document.createElement('table');
            savingsTable.style.width = '100%';
            savingsTable.style.borderCollapse = 'collapse';
            savingsTable.style.marginBottom = '12px';
            savingsTable.style.fontSize = '12px';
            savingsTable.style.tableLayout = 'fixed';

            function addTableRow(table, left, right) {
                var tr = document.createElement('tr');
                var td1 = document.createElement('td');
                td1.textContent = left;
                td1.style.border = '1px solid #ccc';
                td1.style.padding = '8px';
                td1.style.width = '60%';
                td1.style.fontWeight = '700';
                td1.style.fontSize = '12px';
                var td2 = document.createElement('td');
                td2.textContent = right;
                td2.style.border = '1px solid #ccc';
                td2.style.padding = '8px';
                td2.style.fontSize = '12px';
                tr.appendChild(td1);
                tr.appendChild(td2);
                table.appendChild(tr);
            }

            // Read calculated values from DOM
            var totalTimeSaved = document.getElementById('totalTimeSaved').textContent;
            var annualSavings = document.getElementById('annualSavings').textContent;
            var errorCostSavings = document.getElementById('errorCostSavings').textContent;
            var perSampleSavings = document.getElementById('perSampleSavings').textContent;
            var totalAnnualSavings = document.getElementById('totalAnnualSavings').textContent;

            addTableRow(savingsTable, 'Total Time Saved', totalTimeSaved);
            addTableRow(savingsTable, 'Labor Cost Savings', annualSavings);
            addTableRow(savingsTable, 'Error Cost Savings', errorCostSavings);
            addTableRow(savingsTable, 'Savings per Sample', perSampleSavings);
            addTableRow(savingsTable, 'Total Annual Savings', totalAnnualSavings);

            report.appendChild(savingsTable);

            // Value cards row
            var cardsRow = document.createElement('div');
            cardsRow.style.display = 'flex';
            cardsRow.style.gap = '12px';
            cardsRow.style.marginTop = '12px';

            function makeCard(title, value) {
                var c = document.createElement('div');
                c.style.flex = '1 1 0';
                c.style.minWidth = '0';
                c.style.background = '#ffffff';
                c.style.color = '#0b6b66';
                c.style.borderRadius = '8px';
                c.style.padding = '12px';
                c.style.border = '4px solid #0b6b66';
                c.style.boxSizing = 'border-box';
                c.style.textAlign = 'center';
                var h = document.createElement('div');
                h.textContent = title;
                h.style.fontWeight = '800';
                h.style.marginBottom = '8px';
                h.style.color = '#0b6b66';
                var v = document.createElement('div');
                v.textContent = value;
                v.style.fontSize = '16px';
                v.style.fontWeight = '800';
                v.style.color = '#0b6b66';
                c.appendChild(h);
                c.appendChild(v);
                return c;
            }

            cardsRow.appendChild(makeCard('Return on Investment', document.getElementById('roi').textContent));
            cardsRow.appendChild(makeCard('Payback Period', document.getElementById('payback').textContent));
            cardsRow.appendChild(makeCard('Net Benefit', document.getElementById('netBenefit').textContent));

            report.appendChild(cardsRow);

            // Assumptions & Formulas
            var sep = document.createElement('hr');
            sep.style.border = 'none';
            sep.style.borderTop = '1px solid #ddd';
            sep.style.margin = '14px 0';
            report.appendChild(sep);

            var af = document.createElement('div');
            af.style.fontSize = '11px';
            af.style.color = '#222';
            af.style.lineHeight = '1.35';

            var afTitle = document.createElement('h2');
            afTitle.textContent = 'Assumptions & Formulas';
            afTitle.style.margin = '6px 0 8px 0';
            afTitle.style.fontSize = '15px';
            afTitle.style.color = '#0b6b66';
            afTitle.style.fontWeight = '800';
            af.appendChild(afTitle);

            var assumptionsHeading = document.createElement('h3');
            assumptionsHeading.textContent = 'Assumptions';
            assumptionsHeading.style.margin = '8px 0 6px 0';
            assumptionsHeading.style.fontSize = '12px';
            assumptionsHeading.style.color = '#0b6b66';
            assumptionsHeading.style.fontWeight = '700';
            af.appendChild(assumptionsHeading);

            var assumptionsList = document.createElement('div');
            assumptionsList.innerHTML = assumptionsHTML;
            af.appendChild(assumptionsList);

            var formulasHeading = document.createElement('h3');
            formulasHeading.textContent = 'Formulas';
            formulasHeading.style.margin = '8px 0 6px 0';
            formulasHeading.style.fontSize = '12px';
            formulasHeading.style.color = '#0b6b66';
            formulasHeading.style.fontWeight = '700';
            af.appendChild(formulasHeading);

            var formulasList = document.createElement('div');
            formulasList.innerHTML = formulasHTML;
            af.appendChild(formulasList);

            report.appendChild(af);

            // Add page break control and spacer
            var pageBreak = document.createElement('div');
            pageBreak.style.pageBreakAfter = 'always';
            pageBreak.style.height = '1px';
            pageBreak.style.visibility = 'hidden';
            
            var footerSpacer = document.createElement('div');
            footerSpacer.style.width = '100%';
            footerSpacer.style.height = '150px';
            footerSpacer.style.minHeight = '150px';
            
            report.appendChild(pageBreak);
            report.appendChild(footerSpacer);

            // Render to PDF with proper margins and no header/footer overlap
            var margin = { left: 20, right: 20, top: 60, bottom: 100 };
            var pageWidth = doc.internal.pageSize.getWidth();
            var pageHeight = doc.internal.pageSize.getHeight();

            doc.html(report, {
                callback: function (doc) {
                    var totalPages = doc.getNumberOfPages();
                    var nowStr = new Date().toLocaleString();

                    // Add header and footer after content is rendered
                    for (var i = 1; i <= totalPages; i++) {
                        doc.setPage(i);

                        // Header
                        doc.setFontSize(11);
                        doc.setTextColor('#0b6b66');
                        var headerText = 'PCR.AI ROI Report';
                        var headerWidth = doc.getTextWidth(headerText);
                        doc.text(headerText, (pageWidth - headerWidth) / 2, 30);

                        // Footer  
                        doc.setFontSize(8);
                        doc.setTextColor(100);
                        var leftFooter = 'Generated: ' + nowStr;
                        doc.text(leftFooter, margin.left, pageHeight - 20);

                        var pageStr = 'Page ' + i + ' of ' + totalPages;
                        var pageStrWidth = doc.getTextWidth(pageStr);
                        doc.text(pageStr, pageWidth - margin.right - pageStrWidth, pageHeight - 20);
                    }

                    window.open(doc.output('bloburl'), '_blank');
                },
                x: margin.left,
                y: margin.top,
                width: pageWidth - margin.left - margin.right,
                windowWidth: pageWidth - margin.left - margin.right,
                html2canvas: {
                    scale: 0.75
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            var inputs = document.querySelectorAll('input');
            for (var i = 0; i < inputs.length; i++) {
                inputs[i].addEventListener('input', function() {
                    calculateROI();
                    updateLicenseCost();
                });
                inputs[i].addEventListener('change', function() {
                    calculateROI();
                    updateLicenseCost();
                });
            }
            document.querySelectorAll('input[name="calculationMode"]').forEach(function (radio) {
                radio.addEventListener('change', function () {
                    var mode = document.querySelector('input[name="calculationMode"]:checked').value;
                    var annualInputs = document.getElementById('annualVolumeInputs');
                    var runInputs = document.getElementById('runFrequencyInputs');

                    if (mode === 'annual') {
                        annualInputs.style.display = 'block';
                        runInputs.style.display = 'none';
                    } else {
                        annualInputs.style.display = 'none';
                        runInputs.style.display = 'block';
                    }

                    calculateROI();
                    updateLicenseCost();
                });
            });

            // Add robust listeners to frequency select and runsPerFrequency input
            var freqEl = document.getElementById('frequency');
            var runsEl = document.getElementById('runsPerFrequency');
            if (freqEl) {
                freqEl.addEventListener('change', function() {
                    // Ensure runs mode is active when frequency changes
                    var runsRadio = document.querySelector('input[name="calculationMode"][value="runs"]');
                    if (runsRadio) runsRadio.checked = true;
                    // show run inputs
                    document.getElementById('annualVolumeInputs').style.display = 'none';
                    document.getElementById('runFrequencyInputs').style.display = 'block';
                    calculateROI();
                    updateLicenseCost();
                });
                freqEl.addEventListener('input', function() {
                    var runsRadio = document.querySelector('input[name="calculationMode"][value="runs"]');
                    if (runsRadio) runsRadio.checked = true;
                    document.getElementById('annualVolumeInputs').style.display = 'none';
                    document.getElementById('runFrequencyInputs').style.display = 'block';
                    calculateROI();
                    updateLicenseCost();
                });
            }
            if (runsEl) {
                runsEl.addEventListener('input', function() {
                    var runsRadio = document.querySelector('input[name="calculationMode"][value="runs"]');
                    if (runsRadio) runsRadio.checked = true;
                    document.getElementById('annualVolumeInputs').style.display = 'none';
                    document.getElementById('runFrequencyInputs').style.display = 'block';
                    calculateROI();
                    updateLicenseCost();
                });
                runsEl.addEventListener('change', function() {
                    var runsRadio = document.querySelector('input[name="calculationMode"][value="runs"]');
                    if (runsRadio) runsRadio.checked = true;
                    document.getElementById('annualVolumeInputs').style.display = 'none';
                    document.getElementById('runFrequencyInputs').style.display = 'block';
                    calculateROI();
                    updateLicenseCost();
                });
            }

            calculateROI();
            updateLicenseCost();
        });

        function resetForm() {
                const defaultValues = {
                    runsPerFrequency: '5',
                    frequency: 'Per Day',
                    techHourlyRate: '35',
                    supervisorRate: '45',
                    currentAnalysisTime: '60',
                    errorRateReduction: '3',
                    qcTimeSavings: '90',
                    samplesPerRun: '90',
                    pcraiCost: '90000'
                };

                const inputs = document.querySelectorAll('input');
                inputs.forEach(input => {
                    if (input.type === 'radio') {
                        input.checked = input.defaultChecked;
                    } else if (defaultValues[input.id] !== undefined) {
                        input.value = defaultValues[input.id];
                    }
                });

                const selectElements = document.querySelectorAll('select');
                selectElements.forEach(select => {
                    if (defaultValues[select.id] !== undefined) {
                        select.value = defaultValues[select.id];
                    }
                });

                calculateROI();
            }
    </script>
</body>

</html>